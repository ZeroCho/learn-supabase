<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>인증 콜백 처리 중...</title>
    <meta
      name="description"
      content="OAuth, Magic Link, 이메일 인증 콜백 처리"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 500px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .success {
        color: #10b981;
        font-size: 24px;
        margin: 20px 0;
      }
      .error {
        color: #ef4444;
        font-size: 24px;
        margin: 20px 0;
      }
      .info {
        color: #6b7280;
        margin-top: 20px;
      }
      pre {
        background: #f3f4f6;
        padding: 15px;
        border-radius: 6px;
        text-align: left;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loading">
        <div class="spinner"></div>
        <h2>인증 처리 중...</h2>
      </div>
      <div id="success" style="display: none">
        <div class="success">✅ 로그인 성공!</div>
        <div class="info">
          <p><strong>사용자 정보:</strong></p>
          <pre id="userInfo"></pre>
        </div>
        <button
          onclick="window.close()"
          style="
            margin-top: 20px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
          "
        >
          창 닫기
        </button>
      </div>
      <div id="error" style="display: none">
        <div class="error">❌ 인증 실패</div>
        <div class="info">
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>

    <script>
      // Supabase 클라이언트 초기화
      const supabaseUrl = "YOUR_SUPABASE_URL";
      const supabaseAnonKey = "YOUR_SUPABASE_ANON_KEY";

      // Supabase 클라이언트 생성 (CDN에서 로드된 supabase 객체 사용)
      let supabaseClient;
      if (typeof supabase !== "undefined" && supabase.createClient) {
        supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
      } else {
        console.error("Supabase 라이브러리가 로드되지 않았습니다.");
      }

      async function handleAuthCallback() {
        try {
          // URL의 해시나 쿼리 파라미터에서 세션 정보 추출
          const { data, error } = await supabaseClient.auth.getSession();

          if (error) {
            throw error;
          }

          if (data.session) {
            // 성공
            document.getElementById("loading").style.display = "none";
            document.getElementById("success").style.display = "block";

            const userInfo = {
              id: data.session.user.id,
              email: data.session.user.email,
              provider: data.session.user.app_metadata?.provider || "email",
              created_at: data.session.user.created_at,
            };

            document.getElementById("userInfo").textContent = JSON.stringify(
              userInfo,
              null,
              2
            );

            console.log("✅ 로그인 성공:", userInfo);

            // 부모 창에 메시지 전송 (팝업인 경우)
            if (window.opener) {
              window.opener.postMessage(
                { type: "SUPABASE_AUTH_SUCCESS", session: data.session },
                "*"
              );
            }
          } else {
            throw new Error("세션이 없습니다.");
          }
        } catch (error) {
          console.error("인증 오류:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("error").style.display = "block";
          document.getElementById("errorMessage").textContent =
            error.message || "알 수 없는 오류가 발생했습니다.";
        }
      }

      // 페이지 로드 시 실행
      window.addEventListener("DOMContentLoaded", handleAuthCallback);

      // Supabase 인증 상태 변경 감지
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log("Supabase 인증 상태 변경:", event, session);
        if (event === "SIGNED_IN" && session) {
          handleAuthCallback();
        }
      });
    </script>
  </body>
</html>
